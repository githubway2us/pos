<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายการสินค้า</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Prompt', sans-serif; background-color: #f0f2f5; color: #333; padding: 20px; line-height: 1.6; }
        h1 { text-align: center; color: #ffffff; font-size: 2.2em; margin-bottom: 20px; background-color: #034d13; padding: 15px; border-radius: 10px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header a { text-decoration: none; background-color: #007bff; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 500; transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.08);}
        .header a:hover { background-color: #0056b3; transform: translateY(-2px) scale(1.03); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }

        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .cart, .product-list { flex: 1; min-width: 300px; }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .product-card { background-color: white; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.10); padding: 18px; text-align: center; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .product-card:hover { transform: translateY(-7px) scale(1.03); box-shadow: 0 8px 28px rgba(0,0,0,0.18); }
        .product-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 12px; }
        .product-card h2 { font-size: 1.2em; margin: 10px 0; color: #333; background-color: #fff3cd; padding: 7px; border-radius: 7px; }
        .product-card p { font-size: 1em; color: #555; background-color: #d4edda; padding: 7px; border-radius: 7px; }

        /* Receipt style */
        .receipt {
            background-color: #fffdf5;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.12);
            max-width: 370px;
            margin: 0 auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
        }
        .receipt h3 { text-align:center; margin-bottom:7px; }
        .cart-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:7px; gap: 8px;}
        .remove-button {
            background: #ff4d4d;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 4px 12px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            margin-left: 8px;
        }
        .remove-button:hover { background: #e63939; transform: scale(1.07);}
        .big-button { font-size:1.2em; padding:12px; width:100%; background-color:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer; transition:0.3s; margin-top:15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);}
        .big-button:hover { background-color:#45a049; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; transition: opacity 0.3s;}
        .modal-content { background-color: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 420px; text-align: center; box-shadow:0 4px 20px rgba(0,0,0,0.22); }
        .numpad { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:22px 0; }
        .numpad button { font-size:1.2em; padding:17px; background-color:#007bff; color:white; border:none; border-radius:10px; cursor:pointer; transition:0.3s; }
        .numpad button:hover { background-color:#0056b3; }
        .modal button.clear-btn { background-color:#ff4d4d; }
        .modal button.clear-btn:hover { background-color:#e63939; }
        .modal button.confirm-btn { background-color:#4caf50; }
        .modal button.confirm-btn:hover { background-color:#45a049; }
        input[type="text"], input[type="number"] {
            border: 1.5px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            font-size: 1.1em;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: border 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border: 1.5px solid #007bff;
            outline: none;
            background: #fff;
        }

        @media(max-width:768px){ .container{flex-direction:column;} .product-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));} .modal-content{width:95%;} }
        @media(max-width:480px){ .product-card img{height:120px;} .header a{width:100%; text-align:center; margin-bottom:10px;} .big-button{font-size:1em;} }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <a href="{{ url_for('add_product') }}"><i class="fas fa-plus-circle"></i> เพิ่มสินค้า</a>
            <a href="{{ url_for('delete_page') }}"><i class="fas fa-trash-alt"></i> ลบสินค้า</a>
            <a href="{{ url_for('dashboard') }}"><i class="fas fa-chart-bar"></i> แดชบอร์ด</a>
        </div>
    </div>

    <div class="container">
        <!-- Cart Section -->
        <div class="cart">
            <div class="receipt">
                <h3>ร้านอุ๊ล้านรัก พวงมาลัย ดอกไม้สด</h3>
                <p style="text-align:center; font-size:0.9em; margin-bottom:5px;">เลขประจำตัวผู้เสียภาษี: -</p>
                <p style="text-align:center; font-size:0.9em; margin-bottom:15px;">
                    วันที่: <span id="receiptDate"></span><br>
                    เลขที่ใบเสร็จ: <span id="receiptNumber"></span>
                </p>
                <hr style="border:1px dashed #333; margin-bottom:10px;">
                <div id="cartItems"></div>
                <hr style="border:1px dashed #333; margin-top:10px; margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2em; margin-bottom:10px;">
                    <span>รวม</span>
                    <span>฿<span id="totalAmount">0.00</span></span>
                </div>
                <div style="text-align:center; font-size:0.9em; margin-bottom:15px;">
                    ขอบคุณที่ใช้บริการ!
                </div>
                <button class="big-button" onclick="openPaymentModal()">ชำระเงิน</button>
            </div>
        </div>

        <!-- Product List Section -->
        <div class="product-list">
            <h1>รายการสินค้า</h1>
            <div class="product-grid">
                {% if products %}
                    {% for product in products %}
                    <div class="product-card" onclick="openModal('{{ product.name }}', {{ product.price }}, '{{ product.image }}')">
                        <img src="{{ url_for('static', filename=product.image.replace('static/', '')) }}" alt="{{ product.name }}">
                        <h2>{{ product.name }}</h2>
                        <p>฿{{ product.price | round(2) }}</p>
                    </div>
                    
                    {% endfor %}
                {% else %}
                    <p>ไม่มีสินค้าพร้อมจำหน่าย กรุณาเพิ่มสินค้าใหม่!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h1 id="modalTitle"></h1>
            <img id="modalImage" src="" alt="Product Image" style="width:100px; height:100px; border-radius:8px; margin-bottom:15px;">
            <p>ราคา: ฿<span id="modalPrice"></span></p>
            <input type="text" id="quantity" value="0" disabled style="text-align:center; font-size:1.2em; width:100px; padding:10px; background-color:#333; color:white; border:none; border-radius:8px; margin-bottom:10px;">
            <div class="numpad">
                <button onclick="appendNumber(1)">1</button>
                <button onclick="appendNumber(2)">2</button>
                <button onclick="appendNumber(3)">3</button>
                <button onclick="appendNumber(4)">4</button>
                <button onclick="appendNumber(5)">5</button>
                <button onclick="appendNumber(6)">6</button>
                <button onclick="appendNumber(7)">7</button>
                <button onclick="appendNumber(8)">8</button>
                <button onclick="appendNumber(9)">9</button>
                <button onclick="appendNumber(0)">0</button>
                <button onclick="clearQuantity()" class="clear-btn">ล้าง</button>
                <button onclick="addToCart()" class="confirm-btn">ยืนยัน</button>
            </div>
            <button onclick="closeModal()" style="background-color:#ff4d4d;">x CLOSE x</button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h1>รับเงินจากลูกค้า</h1>
            <div id="paymentCartItems" style="margin-bottom:20px;"></div>
            <label for="paymentAmount">จำนวนเงินที่รับ:</label>
            <input type="number" id="paymentAmount" placeholder="0.00" style="width:100%; padding:10px; font-size:1.2em; border-radius:8px; border:1.5px solid #ccc;" oninput="calculateChange()">
            <h3 style="color:red; font-size:1.2em;" id="changeMessage"></h3>
            <button onclick="processPayment()" class="big-button">ยืนยันการชำระ</button>
            <button onclick="closeModal()" class="big-button" style="background-color:#ff4d4d;">ปิด</button>
        </div>
    </div>

    <script>
        let cart = [];
        let totalAmount = 0;

        document.getElementById('receiptDate').textContent = new Date().toLocaleString('th-TH', { dateStyle:'short', timeStyle:'short' });
        document.getElementById('receiptNumber').textContent = 'RC' + Math.floor(Math.random()*1000000);

        function openModal(name, price, image) {
            document.getElementById("modalTitle").textContent = name;
            document.getElementById("modalPrice").textContent = price.toFixed(2);
            document.getElementById("modalImage").src = image;
            document.getElementById("productModal").style.display = "flex";
            document.getElementById("quantity").value = "0";
        }
        function closeModal() { document.getElementById("productModal").style.display="none"; document.getElementById("paymentModal").style.display="none"; }
        function appendNumber(num) { let q=document.getElementById("quantity"); q.value=(q.value==="0"?num:q.value+num); }
        function clearQuantity() { document.getElementById("quantity").value="0"; }
        function addToCart() {
            let quantity=parseInt(document.getElementById("quantity").value);
            if(quantity<=0){ alert("กรุณาระบุจำนวนสินค้าที่มากกว่า 0"); return; }
            let price=parseFloat(document.getElementById("modalPrice").textContent);
            let totalPrice=quantity*price;
            let product=document.getElementById("modalTitle").textContent;
            cart.push({ product, quantity, totalPrice });
            totalAmount+=totalPrice;
            updateCart();
            closeModal();
        }
        function updateCart() {
            let cartItems=document.getElementById("cartItems");
            let paymentCartItems=document.getElementById("paymentCartItems");
            cartItems.innerHTML=""; paymentCartItems.innerHTML="";
            cart.forEach((item,index)=>{
                let el=document.createElement("div");
                el.classList.add("cart-item");
                el.innerHTML=`${item.quantity} x ${item.product} - ฿${item.totalPrice.toFixed(2)}
                    <button class="remove-button" onclick="removeFromCart(${index})">ลบ</button>`;
                cartItems.appendChild(el);
                paymentCartItems.appendChild(el.cloneNode(true));
            });
            document.getElementById("totalAmount").textContent=totalAmount.toFixed(2);
        }
        function removeFromCart(index){ totalAmount-=cart[index].totalPrice; cart.splice(index,1); updateCart(); }
        function openPaymentModal(){ if(cart.length===0){ alert("กรุณาเพิ่มสินค้าในตะกร้าก่อนชำระเงิน!"); return; } document.getElementById("paymentModal").style.display="flex"; updateCart(); }
        function calculateChange(){ let pay=parseFloat(document.getElementById("paymentAmount").value)||0; let msg=document.getElementById("changeMessage"); if(pay>=totalAmount){ msg.textContent=`เงินทอน: ฿${(pay-totalAmount).toFixed(2)}`; msg.style.color="green"; }else{ msg.textContent="จำนวนเงินไม่เพียงพอ!"; msg.style.color="red"; } }
        function processPayment() {
            let pay = parseFloat(document.getElementById("paymentAmount").value) || 0;
            if (pay < totalAmount) {
                alert("จำนวนเงินไม่เพียงพอ!");
                return;
            }

            const paymentDetails = {
                totalAmount: totalAmount,
                paymentAmount: pay,
                cart: cart.map(item => ({
                    product: item.product,
                    quantity: item.quantity,
                    totalPrice: item.totalPrice
                }))
            };

            fetch('/save_payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentDetails)
            }).then(response => response.json()).then(data => {
                if (data.message) {
                    fetch('/save_transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            total: totalAmount,
                            payment: pay,
                            change: pay - totalAmount
                        })
                    }).then(() => {
                        alert(`ชำระเงินสำเร็จ! เงินทอน: ฿${(pay - totalAmount).toFixed(2)}`);
                        cart = [];
                        totalAmount = 0;
                        updateCart();
                        closeModal();
                        setTimeout(() => window.location.href = "{{ url_for('dashboard') }}", 1000);
                    });
                } else {
                    alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล!');
                }
            }).catch(error => {
                alert('เกิดข้อผิดพลาด: ' + error.message);
            });
        }

    </script>
</body>
</html>