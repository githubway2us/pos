<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดการขาย</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Prompt', sans-serif; background-color: #f0f2f5; color: #333; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 40px auto; }
        h1 { text-align: center; color: #034d13; font-size: 2.2em; margin-bottom: 30px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background-color: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); text-align: center; transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { font-size: 1.3em; color: #333; margin-bottom: 10px; }
        .card p { font-size: 1.5em; color: #4caf50; font-weight: bold; }
        .chart-container { background-color: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .product-list { background-color: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .product-list h3 { font-size: 1.5em; color: #333; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #034d13; color: white; font-weight: 500; }
        tr:hover { background-color: #f9f9f9; }
        .back-link { display: block; text-align: center; color: #007bff; margin-top: 20px; font-size: 1em; text-decoration: none; transition: color 0.3s ease; }
        .back-link:hover { color: #0056b3; text-decoration: underline; }
        .file-upload { text-align: center; margin-bottom: 20px; }
        .file-upload input { padding: 10px; font-size: 1em; border-radius: 8px; border: 1px solid #ccc; }
        .btn { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; background-color: #4caf50; color: white; font-weight: bold; margin-left: 10px; }
        .btn:hover { background-color: #388e3c; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } .container { margin: 20px; padding: 15px; } h1 { font-size: 1.8em; } .card p { font-size: 1.2em; } }
        @media (max-width: 480px) { h1 { font-size: 1.5em; } th, td { padding: 8px; font-size: 0.9em; } .file-upload input, .btn { width: 100%; margin: 5px 0; } }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-chart-bar"></i> แดชบอร์ดการขาย</h1>

        <div class="file-upload">
            <input type="file" id="csvFile" accept=".csv" onchange="loadCSV(event)">
            <button class="btn" onclick="exportCSV()">ดาวน์โหลดรายงาน CSV</button>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>ยอดขายรวม</h3>
                <p id="totalSalesAmount">฿0.00</p>
            </div>
            <div class="card">
                <h3>จำนวนสินค้าที่ขาย</h3>
                <p id="totalItemsAmount">0</p>
            </div>
            <div class="card">
                <h3>ยอดขายเฉลี่ยต่อรายการ</h3>
                <p id="avgSaleAmount">฿0.00</p>
            </div>
        </div>

        <div class="chart-container">
            <label for="monthSelect">เลือกเดือน: </label>
            <select id="monthSelect" onchange="filterByMonth()">
                <option value="all">ทั้งหมด</option>
            </select>
            <canvas id="salesChart"></canvas>
        </div>

        <div class="product-list">
            <h3>สรุปยอดขายตามสินค้า</h3>
            <table id="productTable">
                <thead>
                    <tr>
                        <th>ชื่อสินค้า</th>
                        <th>จำนวนที่ขาย</th>
                        <th>ยอดขายรวม</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <a href="{{ url_for('index') }}" class="back-link"><i class="fas fa-arrow-left"></i> กลับสู่หน้าหลัก</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let salesData = [];
        let filteredData = [];
        let salesChart;

        async function loadSalesData() {
            try {
                const response = await fetch('/api/sales_data');
                const data = await response.json();
                salesData = data.map(item => ({
                    product: item.product,
                    date: new Date(item.date),
                    quantity: parseInt(item.quantity),
                    price: parseFloat(item.price),
                    totalSales: parseFloat(item.totalSales)
                }));
                populateMonthDropdown();
                filteredData = [...salesData];
                updateDashboard();
                updateChart();
                displayProductSummary();
            } catch (error) {
                console.error('Error loading sales data:', error);
                alert('เกิดข้อผิดพลาดในการโหลดข้อมูลการขาย');
            }
        }

        function populateMonthDropdown() {
            const monthSelect = document.getElementById('monthSelect');
            monthSelect.innerHTML = '<option value="all">ทั้งหมด</option>';
            const months = [...new Set(salesData.map(item => item.date.getFullYear() + '-' + String(item.date.getMonth()+1).padStart(2,'0')))];
            months.sort();
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.text = month;
                monthSelect.appendChild(option);
            });
        }

        function filterByMonth() {
            const selected = document.getElementById('monthSelect').value;
            filteredData = selected === "all" ? [...salesData] : salesData.filter(item => {
                const m = item.date.getFullYear() + '-' + String(item.date.getMonth()+1).padStart(2,'0');
                return m === selected;
            });
            updateDashboard();
            updateChart();
            displayProductSummary();
        }

        function updateDashboard() {
            const totalSales = filteredData.reduce((sum, item) => sum + item.totalSales, 0);
            const totalItemsSold = filteredData.reduce((sum, item) => sum + item.quantity, 0);
            const avgSale = filteredData.length ? totalSales / filteredData.length : 0;
            document.getElementById('totalSalesAmount').textContent = `฿${totalSales.toFixed(2)}`;
            document.getElementById('totalItemsAmount').textContent = totalItemsSold;
            document.getElementById('avgSaleAmount').textContent = `฿${avgSale.toFixed(2)}`;
        }

        function updateChart() {
            const labels = [...new Set(filteredData.map(item => item.product))];
            const salesByProduct = labels.map(product => filteredData.filter(item => item.product === product).reduce((sum, item) => sum + item.totalSales, 0));
            const ctx = document.getElementById('salesChart').getContext('2d');
            if(salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'ยอดขายตามสินค้า (บาท)', data: salesByProduct, backgroundColor: 'rgba(76, 175, 80, 0.6)', borderColor: 'rgba(76, 175, 80, 1)', borderWidth: 1 }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'ยอดขาย (บาท)' } }, x: { title: { display: true, text: 'ชื่อสินค้า' } } }, plugins: { legend: { display: true, position: 'top' } } }
            });
        }

        function displayProductSummary() {
            const aggregatedData = filteredData.reduce((acc, item) => {
                if (!acc[item.product]) acc[item.product] = { totalQuantity: 0, totalSales: 0 };
                acc[item.product].totalQuantity += item.quantity;
                acc[item.product].totalSales += item.totalSales;
                return acc;
            }, {});
            const sortedProducts = Object.keys(aggregatedData).map(product => ({ product, totalQuantity: aggregatedData[product].totalQuantity, totalSales: aggregatedData[product].totalSales })).sort((a, b) => b.totalSales - a.totalSales);
            const tableBody = document.getElementById('productTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            sortedProducts.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${product.product}</td><td>${product.totalQuantity}</td><td>฿${product.totalSales.toFixed(2)}</td>`;
                tableBody.appendChild(row);
            });
        }

        function loadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n');
                salesData = [];
                rows.forEach((row, index) => {
                    if (index > 0 && row.trim()) {
                        const data = row.split(',');
                        if (data.length >= 5) {
                            const product = data[0].trim();
                            const date = new Date(data[1].trim());
                            const quantity = parseInt(data[2]) || 0;
                            const price = parseFloat(data[3]) || 0;
                            const totalSales = parseFloat(data[4]) || 0;
                            salesData.push({ product, date, quantity, price, totalSales });
                        }
                    }
                });
                populateMonthDropdown();
                filteredData = [...salesData];
                updateDashboard();
                updateChart();
                displayProductSummary();
            };
            reader.readAsText(file);
        }

        function exportCSV() {
            const headers = ["ชื่อสินค้า","จำนวนที่ขาย","ยอดขายรวม"];
            const rows = [];
            const aggregatedData = filteredData.reduce((acc, item) => {
                if (!acc[item.product]) acc[item.product] = { totalQuantity: 0, totalSales: 0 };
                acc[item.product].totalQuantity += item.quantity;
                acc[item.product].totalSales += item.totalSales;
                return acc;
            }, {});
            Object.keys(aggregatedData).forEach(product => {
                const row = [product, aggregatedData[product].totalQuantity, aggregatedData[product].totalSales.toFixed(2)];
                rows.push(row.join(','));
            });
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "sales_report.csv";
            link.click();
        }

        document.addEventListener('DOMContentLoaded', loadSalesData);
    </script>
</body>
</html>
